"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const workspace_1 = require("../utils/workspace");
const path = require("path");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const SCRIPTS = [
    "node_modules/rxjs/bundles/rxjs.umd.js",
    "node_modules/@angular/core/bundles/core.umd.js",
    "node_modules/@angular/common/bundles/common.umd.js",
    "node_modules/@angular/common/bundles/common-http.umd.js",
    "node_modules/@angular/compiler/bundles/compiler.umd.js",
    "node_modules/@angular/elements/bundles/elements.umd.js",
    "node_modules/@angular/platform-browser/bundles/platform-browser.umd.js",
    "node_modules/@angular/platform-browser-dynamic/bundles/platform-browser-dynamic.umd.js"
];
function addExternalsSupport(_options) {
    return (tree, _context) => {
        const project = getProject(tree, _options);
        const relProjectRootPath = project.root.replace(/[^\/]+/g, '..') || '';
        updatePackageJson(project.root || '', tree, _options, _context);
        const templateSource = schematics_1.apply(schematics_1.url('./files'), [
            schematics_1.template(Object.assign(Object.assign({}, _options), { relProjectRootPath, projectRoot: project.root || '' })),
            schematics_1.move(project.root || '/')
        ]);
        return schematics_1.chain([
            addScriptsToProject(tree, _options),
            schematics_1.mergeWith(templateSource),
        ]);
    };
}
exports.addExternalsSupport = addExternalsSupport;
function updatePackageJson(path, tree, _options, _context) {
    const config = loadPackageJson(tree);
    updateScripts(path, config, tree, _options, _context);
    savePackageJson(config, tree);
}
function addScriptsToProject(tree, options) {
    const workspace = workspace_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    if (!project.architect || !project.architect.build || !project.architect.build.options) {
        return schematics_1.noop();
    }
    const buildOptions = project.architect.build.options;
    if (!buildOptions)
        return schematics_1.noop();
    if (!buildOptions.scripts) {
        buildOptions.scripts = [];
    }
    const scripts = buildOptions.scripts;
    SCRIPTS
        .filter(s => !scripts.includes(s))
        .forEach(script => {
        scripts.push(script);
    });
    workspace_1.updateWorkspace(tree, workspace);
    return schematics_1.noop();
}
function getProject(tree, options) {
    const workspace = workspace_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    // compensate for lacking sourceRoot property
    // e. g. when project was migrated to ng7, sourceRoot is lacking
    if (!project.sourceRoot && !project.root) {
        project.sourceRoot = 'src';
    }
    else if (!project.sourceRoot) {
        project.sourceRoot = path.join(project.root, 'src');
    }
    return project;
}
function savePackageJson(config, tree) {
    const newContentAsString = JSON.stringify(config, null, 2) || '';
    tree.overwrite('package.json', newContentAsString);
}
function loadPackageJson(tree) {
    const pkg = tree.read('package.json');
    if (pkg === null)
        throw Error('could not read package.json');
    const contentAsString = pkg.toString('UTF-8');
    const config = JSON.parse(contentAsString);
    return config;
}
function updateScripts(path, config, tree, _options, _context) {
    const project = getProject(tree, _options);
    if (path)
        path += '/';
    if (!config['scripts']) {
        config.scripts = {};
    }
    let additionalFlags = '';
    // Ivy support
    const postInstall = config.scripts['postinstall'] || '';
    //if (postInstall.startsWith('ngcc')) {
    config.scripts['postinstall:bak'] = postInstall;
    config.scripts['postinstall'] = 'ngcc';
    _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'postinstall' }));
    //} 
    if (!_options.host) {
        // external web components need single bundle 
        additionalFlags = '--single-bundle';
    }
    // Heuristic for default project
    if (!project.root) {
        config.scripts['build:externals'] = `ng build --extra-webpack-config ${path}/webpack.externals.js --prod ${additionalFlags}`;
    }
    if (_options.project) {
        config.scripts[`build:${_options.project}:externals`] = `ng build --extra-webpack-config ${path}/webpack.externals.js --prod --project ${_options.project} ${additionalFlags}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNjaGVtYXRpY3MvZXh0ZXJuYWxzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkRBQThJO0FBQzlJLGtEQUFtRTtBQUNuRSw2QkFBNkI7QUFFN0IsNERBQW9FO0FBR3BFLE1BQU0sT0FBTyxHQUFHO0lBQ2QsdUNBQXVDO0lBQ3ZDLGdEQUFnRDtJQUNoRCxvREFBb0Q7SUFDcEQseURBQXlEO0lBQ3pELHdEQUF3RDtJQUN4RCx3REFBd0Q7SUFDeEQsd0VBQXdFO0lBQ3hFLHdGQUF3RjtDQUN6RixDQUFDO0FBRUYsU0FBZ0IsbUJBQW1CLENBQUMsUUFBYTtJQUMvQyxPQUFPLENBQUMsSUFBVSxFQUFFLFFBQTBCLEVBQUUsRUFBRTtRQUVoRCxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUV2RSxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRWhFLE1BQU0sY0FBYyxHQUFHLGtCQUFLLENBQUMsZ0JBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUMzQyxxQkFBUSxpQ0FBSyxRQUFRLEtBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUksRUFBRSxJQUFFO1lBQzVFLGlCQUFJLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUM7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxrQkFBSyxDQUFDO1lBQ1QsbUJBQW1CLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQztZQUNuQyxzQkFBUyxDQUFDLGNBQWMsQ0FBQztTQUM1QixDQUFDLENB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QUFDLElBQUksd0JBQWdCLENBQUMsUUFBUSxFQUFFLEVBQUMsTUFBTSxFQUFFLGFBQWEsRUFBQyxDQUFDLENBQUMsQ0FBQztJQUM1RSxJQUFJO0lBRUosSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUU7UUFDbEIsOENBQThDO1FBQzlDLGVBQWUsR0FBRyxpQkFBaUIsQ0FBQztLQUNyQztJQUVELGdDQUFnQztJQUNoQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtRQUNqQixNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsbUNBQW1DLElBQUksZ0NBQWdDLGVBQWUsRUFBRSxDQUFDO0tBQzlIO0lBRUQsSUFBSSxRQUFRLENBQUMsT0FBTyxFQUFFO1FBQ3BCLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxRQUFRLENBQUMsT0FBTyxZQUFZLENBQUMsR0FBRyxtQ0FBbUMsSUFBSSwwQ0FBMEMsUUFBUSxDQUFDLE9BQU8sSUFBSSxlQUFlLEVBQUUsQ0FBQztLQUNoTDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSdWxlLCBTY2hlbWF0aWNDb250ZXh0LCBUcmVlLCBhcHBseSwgdXJsLCB0ZW1wbGF0ZSwgbW92ZSwgYnJhbmNoQW5kTWVyZ2UsIG1lcmdlV2l0aCwgY2hhaW4sIG5vb3AgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcyc7XG5pbXBvcnQgeyBnZXRXb3Jrc3BhY2UsIHVwZGF0ZVdvcmtzcGFjZSB9IGZyb20gJy4uL3V0aWxzL3dvcmtzcGFjZSc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQnJvd3NlckJ1aWxkZXJCYXNlT3B0aW9ucyB9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS93b3Jrc3BhY2UtbW9kZWxzJztcbmltcG9ydCB7IFJ1blNjaGVtYXRpY1Rhc2sgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcy90YXNrcyc7XG5cblxuY29uc3QgU0NSSVBUUyA9IFtcbiAgXCJub2RlX21vZHVsZXMvcnhqcy9idW5kbGVzL3J4anMudW1kLmpzXCIsXG4gIFwibm9kZV9tb2R1bGVzL0Bhbmd1bGFyL2NvcmUvYnVuZGxlcy9jb3JlLnVtZC5qc1wiLFxuICBcIm5vZGVfbW9kdWxlcy9AYW5ndWxhci9jb21tb24vYnVuZGxlcy9jb21tb24udW1kLmpzXCIsXG4gIFwibm9kZV9tb2R1bGVzL0Bhbmd1bGFyL2NvbW1vbi9idW5kbGVzL2NvbW1vbi1odHRwLnVtZC5qc1wiLFxuICBcIm5vZGVfbW9kdWxlcy9AYW5ndWxhci9jb21waWxlci9idW5kbGVzL2NvbXBpbGVyLnVtZC5qc1wiLFxuICBcIm5vZGVfbW9kdWxlcy9AYW5ndWxhci9lbGVtZW50cy9idW5kbGVzL2VsZW1lbnRzLnVtZC5qc1wiLFxuICBcIm5vZGVfbW9kdWxlcy9AYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyL2J1bmRsZXMvcGxhdGZvcm0tYnJvd3Nlci51bWQuanNcIixcbiAgXCJub2RlX21vZHVsZXMvQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlci1keW5hbWljL2J1bmRsZXMvcGxhdGZvcm0tYnJvd3Nlci1keW5hbWljLnVtZC5qc1wiXG5dO1xuXG5leHBvcnQgZnVuY3Rpb24gYWRkRXh0ZXJuYWxzU3VwcG9ydChfb3B0aW9uczogYW55KTogUnVsZSB7XG4gIHJldHVybiAodHJlZTogVHJlZSwgX2NvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcblxuICAgIGNvbnN0IHByb2plY3QgPSBnZXRQcm9qZWN0KHRyZWUsIF9vcHRpb25zKTtcbiAgICBjb25zdCByZWxQcm9qZWN0Um9vdFBhdGggPSBwcm9qZWN0LnJvb3QucmVwbGFjZSgvW15cXC9dKy9nLCAnLi4nKSB8fCAnJztcblxuICAgIHVwZGF0ZVBhY2thZ2VKc29uKHByb2plY3Qucm9vdCB8fCAnJywgdHJlZSwgX29wdGlvbnMsIF9jb250ZXh0KTtcblxuICAgIGNvbnN0IHRlbXBsYXRlU291cmNlID0gYXBwbHkodXJsKCcuL2ZpbGVzJyksIFtcbiAgICAgIHRlbXBsYXRlKHsuLi5fb3B0aW9ucywgcmVsUHJvamVjdFJvb3RQYXRoLCBwcm9qZWN0Um9vdDogcHJvamVjdC5yb290IHx8ICcnfSksXG4gICAgICBtb3ZlKHByb2plY3Qucm9vdCB8fCAnLycpXG4gICAgXSk7XG5cbiAgICByZXR1cm4gY2hhaW4oW1xuICAgICAgICBhZGRTY3JpcHRzVG9Qcm9qZWN0KHRyZWUsIF9vcHRpb25zKSxcbiAgICAgICAgbWVyZ2VXaXRoKHRlbXBsYXRlU291cmNlKSxcbiAgICBdKTtcblxuICB9XG4gIFxufVxuXG5mdW5jdGlvbiB1cGRhdGVQYWNrYWdlSnNvbihwYXRoOiBzdHJpbmcsIHRyZWU6IFRyZWUsIF9vcHRpb25zOiBhbnksIF9jb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSB7XG4gIGNvbnN0IGNvbmZpZyA9IGxvYWRQYWNrYWdlSnNvbih0cmVlKTtcbiAgdXBkYXRlU2NyaXB0cyhwYXRoLCBjb25maWcsIHRyZWUsIF9vcHRpb25zLCBfY29udGV4dCk7XG4gIHNhdmVQYWNrYWdlSnNvbihjb25maWcsIHRyZWUpO1xufVxuXG5mdW5jdGlvbiBhZGRTY3JpcHRzVG9Qcm9qZWN0KHRyZWU6IFRyZWUsIG9wdGlvbnM6IGFueSk6IFJ1bGUge1xuICBjb25zdCB3b3Jrc3BhY2UgPSBnZXRXb3Jrc3BhY2UodHJlZSk7XG4gIGlmICghb3B0aW9ucy5wcm9qZWN0KSB7XG4gICAgb3B0aW9ucy5wcm9qZWN0ID0gT2JqZWN0LmtleXMod29ya3NwYWNlLnByb2plY3RzKVswXTtcbiAgfVxuICBjb25zdCBwcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzW29wdGlvbnMucHJvamVjdF07XG4gIFxuICBpZiAoIXByb2plY3QuYXJjaGl0ZWN0IHx8ICFwcm9qZWN0LmFyY2hpdGVjdC5idWlsZCB8fCAhcHJvamVjdC5hcmNoaXRlY3QuYnVpbGQub3B0aW9ucykge1xuICAgIHJldHVybiBub29wKCk7XG4gIH1cblxuICBjb25zdCBidWlsZE9wdGlvbnMgPSBwcm9qZWN0LmFyY2hpdGVjdC5idWlsZC5vcHRpb25zIGFzIEJyb3dzZXJCdWlsZGVyQmFzZU9wdGlvbnM7XG5cbiAgaWYgKCFidWlsZE9wdGlvbnMpIHJldHVybiBub29wKCk7XG4gIFxuICBpZiAoIWJ1aWxkT3B0aW9ucy5zY3JpcHRzKSB7XG4gICAgYnVpbGRPcHRpb25zLnNjcmlwdHMgPSBbXTtcbiAgfVxuICBcbiAgY29uc3Qgc2NyaXB0cyA9IGJ1aWxkT3B0aW9ucy5zY3JpcHRzO1xuICBcbiAgU0NSSVBUU1xuICAgIC5maWx0ZXIocyA9PiAhc2NyaXB0cy5pbmNsdWRlcyhzKSlcbiAgICAuZm9yRWFjaChzY3JpcHQgPT4ge1xuICAgICAgc2NyaXB0cy5wdXNoKHNjcmlwdCk7XG4gICAgfSk7XG5cbiAgdXBkYXRlV29ya3NwYWNlKHRyZWUsIHdvcmtzcGFjZSk7XG5cbiAgcmV0dXJuIG5vb3AoKTtcbn1cblxuZnVuY3Rpb24gZ2V0UHJvamVjdCh0cmVlOiBUcmVlLCBvcHRpb25zOiBhbnkpIHtcbiAgY29uc3Qgd29ya3NwYWNlID0gZ2V0V29ya3NwYWNlKHRyZWUpO1xuICBpZiAoIW9wdGlvbnMucHJvamVjdCkge1xuICAgIG9wdGlvbnMucHJvamVjdCA9IE9iamVjdC5rZXlzKHdvcmtzcGFjZS5wcm9qZWN0cylbMF07XG4gIH1cbiAgY29uc3QgcHJvamVjdCA9IHdvcmtzcGFjZS5wcm9qZWN0c1tvcHRpb25zLnByb2plY3RdO1xuXG4gIC8vIGNvbXBlbnNhdGUgZm9yIGxhY2tpbmcgc291cmNlUm9vdCBwcm9wZXJ0eVxuICAvLyBlLiBnLiB3aGVuIHByb2plY3Qgd2FzIG1pZ3JhdGVkIHRvIG5nNywgc291cmNlUm9vdCBpcyBsYWNraW5nXG4gIGlmICghcHJvamVjdC5zb3VyY2VSb290ICYmICFwcm9qZWN0LnJvb3QpIHtcbiAgICBwcm9qZWN0LnNvdXJjZVJvb3QgPSAnc3JjJztcbiAgfVxuICBlbHNlIGlmICghcHJvamVjdC5zb3VyY2VSb290KSB7XG4gICAgcHJvamVjdC5zb3VyY2VSb290ID0gcGF0aC5qb2luKHByb2plY3Qucm9vdCwgJ3NyYycpO1xuICB9XG5cbiAgcmV0dXJuIHByb2plY3Q7XG59XG5cbmZ1bmN0aW9uIHNhdmVQYWNrYWdlSnNvbihjb25maWc6IGFueSwgdHJlZTogVHJlZSkge1xuICBjb25zdCBuZXdDb250ZW50QXNTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShjb25maWcsIG51bGwsIDIpIHx8ICcnO1xuICB0cmVlLm92ZXJ3cml0ZSgncGFja2FnZS5qc29uJywgbmV3Q29udGVudEFzU3RyaW5nKTtcbn1cblxuZnVuY3Rpb24gbG9hZFBhY2thZ2VKc29uKHRyZWU6IFRyZWUpIHtcbiAgY29uc3QgcGtnID0gdHJlZS5yZWFkKCdwYWNrYWdlLmpzb24nKTtcbiAgaWYgKHBrZyA9PT0gbnVsbClcbiAgICB0aHJvdyBFcnJvcignY291bGQgbm90IHJlYWQgcGFja2FnZS5qc29uJyk7XG4gIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IHBrZy50b1N0cmluZygnVVRGLTgnKTtcbiAgY29uc3QgY29uZmlnID0gSlNPTi5wYXJzZShjb250ZW50QXNTdHJpbmcpO1xuICByZXR1cm4gY29uZmlnO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVTY3JpcHRzKHBhdGg6IHN0cmluZywgY29uZmlnOiBhbnksIHRyZWU6IFRyZWUsIF9vcHRpb25zOiBhbnksIF9jb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSB7XG4gIGNvbnN0IHByb2plY3QgPSBnZXRQcm9qZWN0KHRyZWUsIF9vcHRpb25zKTtcbiAgXG4gIGlmIChwYXRoKSBwYXRoICs9ICcvJztcblxuICBpZiAoIWNvbmZpZ1snc2NyaXB0cyddKSB7XG4gICAgY29uZmlnLnNjcmlwdHMgPSB7fTtcbiAgfVxuXG4gIGxldCBhZGRpdGlvbmFsRmxhZ3MgPSAnJztcblxuICAvLyBJdnkgc3VwcG9ydFxuICBjb25zdCBwb3N0SW5zdGFsbDogc3RyaW5nID0gY29uZmlnLnNjcmlwdHNbJ3Bvc3RpbnN0YWxsJ10gfHwgJyc7XG4gIC8vaWYgKHBvc3RJbnN0YWxsLnN0YXJ0c1dpdGgoJ25nY2MnKSkge1xuICAgIGNvbmZpZy5zY3JpcHRzWydwb3N0aW5zdGFsbDpiYWsnXSA9IHBvc3RJbnN0YWxsO1xuICAgIGNvbmZpZy5zY3JpcHRzWydwb3N0aW5zdGFsbCddID0gJ25nY2MnO1xuXG4gICAgX2NvbnRleHQuYWRkVGFzayhuZXcgUnVuU2NoZW1hdGljVGFzaygnbnBtUnVuJywge3NjcmlwdDogJ3Bvc3RpbnN0YWxsJ30pKTtcbiAgLy99IFxuXG4gIGlmICghX29wdGlvbnMuaG9zdCkge1xuICAgIC8vIGV4dGVybmFsIHdlYiBjb21wb25lbnRzIG5lZWQgc2luZ2xlIGJ1bmRsZSBcbiAgICBhZGRpdGlvbmFsRmxhZ3MgPSAnLS1zaW5nbGUtYnVuZGxlJztcbiAgfVxuXG4gIC8vIEhldXJpc3RpYyBmb3IgZGVmYXVsdCBwcm9qZWN0XG4gIGlmICghcHJvamVjdC5yb290KSB7XG4gICAgY29uZmlnLnNjcmlwdHNbJ2J1aWxkOmV4dGVybmFscyddID0gYG5nIGJ1aWxkIC0tZXh0cmEtd2VicGFjay1jb25maWcgJHtwYXRofS93ZWJwYWNrLmV4dGVybmFscy5qcyAtLXByb2QgJHthZGRpdGlvbmFsRmxhZ3N9YDtcbiAgfVxuXG4gIGlmIChfb3B0aW9ucy5wcm9qZWN0KSB7XG4gICAgY29uZmlnLnNjcmlwdHNbYGJ1aWxkOiR7X29wdGlvbnMucHJvamVjdH06ZXh0ZXJuYWxzYF0gPSBgbmcgYnVpbGQgLS1leHRyYS13ZWJwYWNrLWNvbmZpZyAke3BhdGh9L3dlYnBhY2suZXh0ZXJuYWxzLmpzIC0tcHJvZCAtLXByb2plY3QgJHtfb3B0aW9ucy5wcm9qZWN0fSAke2FkZGl0aW9uYWxGbGFnc31gO1xuICB9XG59XG4iXX0=