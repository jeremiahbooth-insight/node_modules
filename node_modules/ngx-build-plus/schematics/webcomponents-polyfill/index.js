"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const workspace_1 = require("../utils/workspace");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const spawn = require('cross-spawn');
// function npmInstall(options: any): Rule {
//   return function (tree: Tree, context: SchematicContext) {
//     spawn.sync('npm', ['install', options.package, options.switch], { stdio: 'inherit' });
//     return tree;
//   }
// }
function npmRun(options) {
    return function (tree, context) {
        spawn.sync('npm', ['run', options.script], { stdio: 'inherit' });
        return tree;
    };
}
exports.npmRun = npmRun;
function addWebComponentsPolyfill(_options) {
    return (tree, _context) => {
        const packageJson = loadPackageJson(tree);
        if (!packageJson['dependencies'] || !packageJson['dependencies']['@webcomponents/webcomponentsjs']) {
            _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: '@webcomponents/webcomponentsjs',
            }));
        }
        return schematics_1.chain([
            addScriptsToProject(tree, _options)
        ]);
    };
}
exports.addWebComponentsPolyfill = addWebComponentsPolyfill;
function addScriptsToProject(tree, options) {
    const workspace = workspace_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    if (!project.architect || !project.architect.build || !project.architect.build.options) {
        return schematics_1.noop();
    }
    const buildOptions = project.architect.build.options;
    if (!buildOptions)
        return schematics_1.noop();
    if (!buildOptions.scripts) {
        buildOptions.scripts = [];
    }
    const scripts = buildOptions.scripts;
    if (!scripts.find(s => s.bundleName === 'polyfill-webcomp-es5')) {
        scripts.push({
            bundleName: 'polyfill-webcomp-es5',
            input: 'node_modules/@webcomponents/webcomponentsjs/custom-elements-es5-adapter.js'
        });
    }
    if (!scripts.find(s => s.bundleName === 'polyfill-webcomp')) {
        scripts.push({
            bundleName: 'polyfill-webcomp',
            input: 'node_modules/@webcomponents/webcomponentsjs/bundles/webcomponents-sd-ce-pf.js'
        });
    }
    workspace_1.updateWorkspace(tree, workspace);
    return schematics_1.noop();
}
function loadPackageJson(tree) {
    const pkg = tree.read('package.json');
    if (pkg === null)
        throw Error('could not read package.json');
    const contentAsString = pkg.toString('UTF-8');
    const config = JSON.parse(contentAsString);
    return config;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNjaGVtYXRpY3Mvd2ViY29tcG9uZW50cy1wb2x5ZmlsbC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJEQUE4STtBQUM5SSxrREFBbUU7QUFDbkUsNERBQTRGO0FBSTVGLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUVyQyw0Q0FBNEM7QUFDNUMsOERBQThEO0FBQzlELDZGQUE2RjtBQUM3RixtQkFBbUI7QUFDbkIsTUFBTTtBQUNOLElBQUk7QUFFSixTQUFnQixNQUFNLENBQUMsT0FBWTtJQUNqQyxPQUFPLFVBQVUsSUFBVSxFQUFFLE9BQXlCO1FBQ3BELEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQUxELHdCQUtDO0FBRUQsU0FBZ0Isd0JBQXdCLENBQUMsUUFBYTtJQUNwRCxPQUFPLENBQUMsSUFBVSxFQUFFLFFBQTBCLEVBQUUsRUFBRTtRQUVoRCxNQUFNLFdBQVcsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFMUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxnQ0FBZ0MsQ0FBQyxFQUFFO1lBQ2xHLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSw4QkFBc0IsQ0FBQztnQkFDMUMsV0FBVyxFQUFFLGdDQUFnQzthQUM5QyxDQUFDLENBQUMsQ0FBQztTQUNMO1FBRUQsT0FBTyxrQkFBSyxDQUFDO1lBQ1gsbUJBQW1CLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQztTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUM7QUFDSixDQUFDO0FBZkQsNERBZUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLElBQVUsRUFBRSxPQUFZO0lBQ2pELE1BQU0sU0FBUyxHQUFHLHdCQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7UUFDcEIsT0FBTyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUN0RDtJQUNELE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXBELElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7UUFDdEYsT0FBTyxpQkFBSSxFQUFFLENBQUM7S0FDZjtJQUVELE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQW9DLENBQUM7SUFFbEYsSUFBSSxDQUFDLFlBQVk7UUFBRSxPQUFPLGlCQUFJLEVBQUUsQ0FBQztJQUVqQyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRTtRQUN6QixZQUFZLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztLQUMzQjtJQUVELE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUEwQyxDQUFDO0lBRXhFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsS0FBSyxzQkFBc0IsQ0FBQyxFQUFFO1FBQy9ELE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDWCxVQUFVLEVBQUUsc0JBQXNCO1lBQ2xDLEtBQUssRUFBRSw0RUFBNEU7U0FDcEYsQ0FBQyxDQUFDO0tBQ0o7SUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLEtBQUssa0JBQWtCLENBQUMsRUFBRTtRQUMzRCxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ1gsVUFBVSxFQUFFLGtCQUFrQjtZQUM5QixLQUFLLEVBQUUsK0VBQStFO1NBQ3ZGLENBQUMsQ0FBQztLQUNKO0lBRUQsMkJBQWUsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDakMsT0FBTyxpQkFBSSxFQUFFLENBQUM7QUFDbEIsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLElBQVU7SUFDakMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUN0QyxJQUFJLEdBQUcsS0FBSyxJQUFJO1FBQ2QsTUFBTSxLQUFLLENBQUMsNkJBQTZCLENBQUMsQ0FBQztJQUM3QyxNQUFNLGVBQWUsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDM0MsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJ1bGUsIFNjaGVtYXRpY0NvbnRleHQsIFRyZWUsIGFwcGx5LCB1cmwsIHRlbXBsYXRlLCBtb3ZlLCBicmFuY2hBbmRNZXJnZSwgbWVyZ2VXaXRoLCBjaGFpbiwgbm9vcCB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzJztcbmltcG9ydCB7IGdldFdvcmtzcGFjZSwgdXBkYXRlV29ya3NwYWNlIH0gZnJvbSAnLi4vdXRpbHMvd29ya3NwYWNlJztcbmltcG9ydCB7IFJ1blNjaGVtYXRpY1Rhc2ssIE5vZGVQYWNrYWdlSW5zdGFsbFRhc2sgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcy90YXNrcyc7XG5pbXBvcnQgeyBCcm93c2VyQnVpbGRlckJhc2VPcHRpb25zIH0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L3dvcmtzcGFjZS1tb2RlbHMnO1xuaW1wb3J0IHsgQWR2YW5jZWRTY3JpcHRDb25mIH0gZnJvbSAnLi4vdXRpbHMvdHlwZXMnO1xuXG5jb25zdCBzcGF3biA9IHJlcXVpcmUoJ2Nyb3NzLXNwYXduJyk7XG5cbi8vIGZ1bmN0aW9uIG5wbUluc3RhbGwob3B0aW9uczogYW55KTogUnVsZSB7XG4vLyAgIHJldHVybiBmdW5jdGlvbiAodHJlZTogVHJlZSwgY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkge1xuLy8gICAgIHNwYXduLnN5bmMoJ25wbScsIFsnaW5zdGFsbCcsIG9wdGlvbnMucGFja2FnZSwgb3B0aW9ucy5zd2l0Y2hdLCB7IHN0ZGlvOiAnaW5oZXJpdCcgfSk7XG4vLyAgICAgcmV0dXJuIHRyZWU7XG4vLyAgIH1cbi8vIH1cblxuZXhwb3J0IGZ1bmN0aW9uIG5wbVJ1bihvcHRpb25zOiBhbnkpOiBSdWxlIHtcbiAgcmV0dXJuIGZ1bmN0aW9uICh0cmVlOiBUcmVlLCBjb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSB7XG4gICAgc3Bhd24uc3luYygnbnBtJywgWydydW4nLCBvcHRpb25zLnNjcmlwdF0sIHsgc3RkaW86ICdpbmhlcml0JyB9KTtcbiAgICByZXR1cm4gdHJlZTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkV2ViQ29tcG9uZW50c1BvbHlmaWxsKF9vcHRpb25zOiBhbnkpOiBSdWxlIHtcbiAgcmV0dXJuICh0cmVlOiBUcmVlLCBfY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkgPT4ge1xuXG4gICAgY29uc3QgcGFja2FnZUpzb24gPSBsb2FkUGFja2FnZUpzb24odHJlZSk7XG5cbiAgICBpZiAoIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXSB8fCAhcGFja2FnZUpzb25bJ2RlcGVuZGVuY2llcyddWydAd2ViY29tcG9uZW50cy93ZWJjb21wb25lbnRzanMnXSkge1xuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzayh7XG4gICAgICAgIHBhY2thZ2VOYW1lOiAnQHdlYmNvbXBvbmVudHMvd2ViY29tcG9uZW50c2pzJyxcbiAgICAgIH0pKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hhaW4oW1xuICAgICAgYWRkU2NyaXB0c1RvUHJvamVjdCh0cmVlLCBfb3B0aW9ucylcbiAgICBdKTsgXG4gIH07XG59XG5cbmZ1bmN0aW9uIGFkZFNjcmlwdHNUb1Byb2plY3QodHJlZTogVHJlZSwgb3B0aW9uczogYW55KTogUnVsZSB7XG4gICAgY29uc3Qgd29ya3NwYWNlID0gZ2V0V29ya3NwYWNlKHRyZWUpO1xuICAgIGlmICghb3B0aW9ucy5wcm9qZWN0KSB7XG4gICAgICBvcHRpb25zLnByb2plY3QgPSBPYmplY3Qua2V5cyh3b3Jrc3BhY2UucHJvamVjdHMpWzBdO1xuICAgIH1cbiAgICBjb25zdCBwcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzW29wdGlvbnMucHJvamVjdF07XG4gICAgXG4gICAgaWYgKCFwcm9qZWN0LmFyY2hpdGVjdCB8fCAhcHJvamVjdC5hcmNoaXRlY3QuYnVpbGQgfHwgIXByb2plY3QuYXJjaGl0ZWN0LmJ1aWxkLm9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBub29wKCk7XG4gICAgfVxuXG4gICAgY29uc3QgYnVpbGRPcHRpb25zID0gcHJvamVjdC5hcmNoaXRlY3QuYnVpbGQub3B0aW9ucyBhcyBCcm93c2VyQnVpbGRlckJhc2VPcHRpb25zO1xuXG4gICAgaWYgKCFidWlsZE9wdGlvbnMpIHJldHVybiBub29wKCk7XG4gICAgXG4gICAgaWYgKCFidWlsZE9wdGlvbnMuc2NyaXB0cykge1xuICAgICAgYnVpbGRPcHRpb25zLnNjcmlwdHMgPSBbXTtcbiAgICB9XG4gICAgXG4gICAgY29uc3Qgc2NyaXB0cyA9IGJ1aWxkT3B0aW9ucy5zY3JpcHRzIGFzIHVua25vd24gYXMgQWR2YW5jZWRTY3JpcHRDb25mW107XG4gICAgXG4gICAgaWYgKCFzY3JpcHRzLmZpbmQocyA9PiBzLmJ1bmRsZU5hbWUgPT09ICdwb2x5ZmlsbC13ZWJjb21wLWVzNScpKSB7XG4gICAgICBzY3JpcHRzLnB1c2goe1xuICAgICAgICBidW5kbGVOYW1lOiAncG9seWZpbGwtd2ViY29tcC1lczUnLFxuICAgICAgICBpbnB1dDogJ25vZGVfbW9kdWxlcy9Ad2ViY29tcG9uZW50cy93ZWJjb21wb25lbnRzanMvY3VzdG9tLWVsZW1lbnRzLWVzNS1hZGFwdGVyLmpzJ1xuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIGlmICghc2NyaXB0cy5maW5kKHMgPT4gcy5idW5kbGVOYW1lID09PSAncG9seWZpbGwtd2ViY29tcCcpKSB7XG4gICAgICBzY3JpcHRzLnB1c2goe1xuICAgICAgICBidW5kbGVOYW1lOiAncG9seWZpbGwtd2ViY29tcCcsXG4gICAgICAgIGlucHV0OiAnbm9kZV9tb2R1bGVzL0B3ZWJjb21wb25lbnRzL3dlYmNvbXBvbmVudHNqcy9idW5kbGVzL3dlYmNvbXBvbmVudHMtc2QtY2UtcGYuanMnXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB1cGRhdGVXb3Jrc3BhY2UodHJlZSwgd29ya3NwYWNlKTtcbiAgICByZXR1cm4gbm9vcCgpO1xufVxuXG5mdW5jdGlvbiBsb2FkUGFja2FnZUpzb24odHJlZTogVHJlZSkge1xuICBjb25zdCBwa2cgPSB0cmVlLnJlYWQoJ3BhY2thZ2UuanNvbicpO1xuICBpZiAocGtnID09PSBudWxsKVxuICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgcmVhZCBwYWNrYWdlLmpzb24nKTtcbiAgY29uc3QgY29udGVudEFzU3RyaW5nID0gcGtnLnRvU3RyaW5nKCdVVEYtOCcpO1xuICBjb25zdCBjb25maWcgPSBKU09OLnBhcnNlKGNvbnRlbnRBc1N0cmluZyk7XG4gIHJldHVybiBjb25maWc7XG59XG4iXX0=